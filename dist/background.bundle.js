(()=>{function e(e,t,o){chrome.tabs.sendMessage(e,{type:"showPrompt",selectedText:t},(e=>{if(e&&void 0!==e.additionalText){const s=e.additionalText,n=s?"".concat(s," ").concat(t):t;o(n)}else o(t)}))}function t(e,t){c(e,"Captured Text with Prompt: "+t),n(e,"Getting AI Response..."),s(e,t,(t=>{c(e,"AI Response: "+t),r(e,"AI Response: ".concat(t)),chrome.runtime.sendMessage({type:"openChat",message:t})}))}function o(){return window.getSelection().toString()||null}function s(e,t,o){fetch("http://localhost:5010/generate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({conversationHistory:[{sender:"user",text:t}]})}).then((e=>e.json())).then((t=>{t&&t.response?o(t.response):(c(e,"Error: No response from AI"),r(e,"Error: No response from AI"))})).catch((t=>{console.error("Error sending text to AI:",t),c(e,"Error: Unable to contact AI server"),r(e,"Error: Unable to contact AI server")}))}function n(e,t){chrome.tabs.sendMessage(e,{type:"customAlert",message:t,loading:!0})}function r(e,t){chrome.tabs.sendMessage(e,{type:"customAlert",message:t,loading:!1})}function c(e,t){chrome.scripting.executeScript({target:{tabId:e},func:e=>console.log(e),args:[t]})}function a(e,t){chrome.tabs.sendMessage(e,{type:"customAlert",message:t,loading:!1})}chrome.runtime.onInstalled.addListener((()=>{chrome.contextMenus.create({id:"captureText",title:"Ask ClickAI about '%s'",contexts:["selection"]}),chrome.contextMenus.create({id:"addPromptAndCaptureText",title:"Add prompt and ask ClickAI about '%s'",contexts:["selection"]}),chrome.contextMenus.create({id:"extractTextFromImage",title:"Extract Text and ask ClickAI",contexts:["image"]})})),chrome.contextMenus.onClicked.addListener(((i,d)=>{if("captureText"===i.menuItemId)!function(e,t){if(e.selectionText){const o=e.selectionText;c(t.id,"Captured Text: "+o),n(t.id,"Getting AI Response..."),s(t.id,o,(e=>{c(t.id,"AI Response: "+e),r(t.id,"AI Response: ".concat(e)),chrome.runtime.sendMessage({type:"openChat",message:e})}))}else chrome.scripting.executeScript({target:{tabId:t.id},function:o},(e=>{if(e&&e[0]&&e[0].result){const o=e[0].result;c(t.id,"Captured Text: "+o),n(t.id,"Getting AI Response..."),s(t.id,o,(e=>{c(t.id,"AI Response: "+e),r(t.id,"AI Response: ".concat(e)),chrome.runtime.sendMessage({type:"openChat",message:e})}))}else c(t.id,"Error: No text selected"),a(t.id,"Error: No text selected")}))}(i,d);else if("addPromptAndCaptureText"===i.menuItemId)if(i.selectionText){const o=i.selectionText;e(d.id,o,(e=>{t(d.id,e)}))}else chrome.scripting.executeScript({target:{tabId:d.id},function:o},(o=>{if(o&&o[0]&&o[0].result){const s=o[0].result;e(d.id,s,(e=>{t(d.id,e)}))}else c(d.id,"Error: No text selected"),a(d.id,"Error: No text selected")}));else if("extractTextFromImage"===i.menuItemId){const e=i.srcUrl;chrome.tabs.sendMessage(d.id,{type:"extractTextFromImage",imageUrl:e},(e=>{e&&e.extractedText?(console.log("Extracted Text: "+e.extractedText),s(d.id,e.extractedText,(e=>{c(d.id,"AI Response: "+e),r(d.id,"AI Response: ".concat(e)),chrome.runtime.sendMessage({type:"openChat",message:e})}))):(c(d.id,"Error: Failed to extract text from image"),a(d.id,"Error: Failed to extract text from image"))}))}})),chrome.runtime.onMessage.addListener(((e,t,o)=>{"openChat"===e.type&&chrome.storage.local.set({aiMessage:e.message},(()=>{chrome.action.setBadgeText({text:"NEW"}),chrome.action.setBadgeBackgroundColor({color:"#00FF00"})}))})),chrome.runtime.onMessage.addListener(((e,t,o)=>{"popupOpened"===e.type&&chrome.action.setBadgeText({text:""})}))})();
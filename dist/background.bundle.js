(()=>{function e(e,t,o){chrome.tabs.sendMessage(e,{type:"showPrompt",selectedText:t},(e=>{if(e&&void 0!==e.additionalText){const n=e.additionalText,r=n?"".concat(n," ").concat(t):t;o(r)}else o(t)}))}function t(e,t){c(e,"Captured Text with Prompt: "+t),r(e,t),n(e,t,(t=>{c(tab.id,"AI Response: "+t),s(e,t),chrome.runtime.sendMessage({type:"openChat",message:t})}))}function o(){return window.getSelection().toString()||null}function n(e,t,o){fetch("http://localhost:5010/generate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({conversationHistory:[{sender:"user",text:t}]})}).then((e=>e.json())).then((t=>{t&&t.response?o(t.response):(c(e,"Error: No response from AI"),s(e,"Error: No response from AI"))})).catch((t=>{console.error("Error sending text to AI:",t),c(e,"Error: Unable to contact AI server"),s(e,"Error: Unable to contact AI server")}))}function r(e,t){chrome.tabs.sendMessage(e,{type:"newUserQuery",query:t,loading:!0})}function s(e,t){chrome.tabs.sendMessage(e,{type:"updateAIResponse",response:t,loading:!1})}function i(e,t){chrome.tabs.sendMessage(e,{type:"customAlert",message:t,loading:!1})}function c(e,t){chrome.scripting.executeScript({target:{tabId:e},func:e=>console.log(e),args:[t]})}chrome.runtime.onInstalled.addListener((()=>{chrome.contextMenus.create({id:"captureText",title:"Ask ClickAI about '%s'",contexts:["selection"]}),chrome.contextMenus.create({id:"addPromptAndCaptureText",title:"Add prompt and ask ClickAI about '%s'",contexts:["selection"]})})),chrome.contextMenus.onClicked.addListener(((a,d)=>{"captureText"===a.menuItemId?function(e,t){if(e.selectionText){const o=e.selectionText;c(t.id,"Captured Text: "+o),r(t.id,o),n(t.id,o,(e=>{c(t.id,"AI Response: "+e),s(t.id,e),chrome.runtime.sendMessage({type:"openChat",message:e})}))}else chrome.scripting.executeScript({target:{tabId:t.id},function:o},(e=>{if(e&&e[0]&&e[0].result){const o=e[0].result;c(t.id,"Captured Text: "+o),r(t.id,o),n(t.id,o,(e=>{c(t.id,"AI Response: "+e),s(t.id,e),chrome.runtime.sendMessage({type:"openChat",message:e})}))}else c(t.id,"Error: No text selected"),i(t.id,"Error: No text selected")}))}(a,d):"addPromptAndCaptureText"===a.menuItemId&&function(n,r){if(n.selectionText){const o=n.selectionText;e(r.id,o,(e=>{t(r.id,e)}))}else chrome.scripting.executeScript({target:{tabId:r.id},function:o},(o=>{if(o&&o[0]&&o[0].result){const n=o[0].result;e(r.id,n,(e=>{t(r.id,e)}))}else c(r.id,"Error: No text selected"),i(r.id,"Error: No text selected")}))}(a,d)})),chrome.runtime.onMessage.addListener(((e,t,o)=>{if("openChat"===e.type&&chrome.storage.local.set({aiMessage:e.message},(()=>{chrome.action.setBadgeText({text:"NEW"}),chrome.action.setBadgeBackgroundColor({color:"#00FF00"})})),"popupOpened"===e.type&&chrome.action.setBadgeText({text:""}),"continueChat"===e.type)return fetch("http://localhost:5010/generate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({conversationHistory:e.conversationHistory,continueId:e.continueId})}).then((e=>e.json())).then((e=>{e&&e.response?o({response:e.response,id:e.id||null,isContinued:e.isContinued||!1}):o({error:"No response from AI"})})).catch((e=>{console.error("Error in continueChat fetch:",e),o({error:"Unable to contact AI server"})})),!0}))})();
(()=>{function e(e,t,o){chrome.tabs.sendMessage(e,{type:"showPrompt",selectedText:t},(e=>{if(e&&void 0!==e.additionalText){const n=e.additionalText,s=n?"".concat(n," ").concat(t):t;o(s)}else o(t)}))}function t(e,t){i(e,"Captured Text with Prompt: "+t),s(e,"Getting AI Response..."),n(e,t,(t=>{i(e,"AI Response: "+t),r(e,"AI Response: ".concat(t)),chrome.runtime.sendMessage({type:"openChat",message:t})}))}function o(){return window.getSelection().toString()||null}function n(e,t,o){fetch("http://localhost:5010/generate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({conversationHistory:[{sender:"user",text:t}]})}).then((e=>e.json())).then((t=>{t&&t.response?o(t.response):(i(e,"Error: No response from AI"),r(e,"Error: No response from AI"))})).catch((t=>{console.error("Error sending text to AI:",t),i(e,"Error: Unable to contact AI server"),r(e,"Error: Unable to contact AI server")}))}function s(e,t){chrome.tabs.sendMessage(e,{type:"customAlert",message:t,loading:!0})}function r(e,t){chrome.tabs.sendMessage(e,{type:"customAlert",message:t,loading:!1})}function c(e,t){chrome.tabs.sendMessage(e,{type:"customAlert",message:t,loading:!1})}function i(e,t){chrome.scripting.executeScript({target:{tabId:e},func:e=>console.log(e),args:[t]})}chrome.runtime.onInstalled.addListener((()=>{chrome.contextMenus.create({id:"captureText",title:"Ask ClickAI about '%s'",contexts:["selection"]}),chrome.contextMenus.create({id:"addPromptAndCaptureText",title:"Add prompt and ask ClickAI about '%s'",contexts:["selection"]})})),chrome.contextMenus.onClicked.addListener(((a,d)=>{"captureText"===a.menuItemId?function(e,t){if(e.selectionText){const o=e.selectionText;i(t.id,"Captured Text: "+o),s(t.id,"Getting AI Response..."),n(t.id,o,(e=>{i(t.id,"AI Response: "+e),r(t.id,"AI Response: ".concat(e)),chrome.runtime.sendMessage({type:"openChat",message:e})}))}else chrome.scripting.executeScript({target:{tabId:t.id},function:o},(e=>{if(e&&e[0]&&e[0].result){const o=e[0].result;i(t.id,"Captured Text: "+o),s(t.id,"Getting AI Response..."),n(t.id,o,(e=>{i(t.id,"AI Response: "+e),r(t.id,"AI Response: ".concat(e)),chrome.runtime.sendMessage({type:"openChat",message:e})}))}else i(t.id,"Error: No text selected"),c(t.id,"Error: No text selected")}))}(a,d):"addPromptAndCaptureText"===a.menuItemId&&function(n,s){if(n.selectionText){const o=n.selectionText;e(s.id,o,(e=>{t(s.id,e)}))}else chrome.scripting.executeScript({target:{tabId:s.id},function:o},(o=>{if(o&&o[0]&&o[0].result){const n=o[0].result;e(s.id,n,(e=>{t(s.id,e)}))}else i(s.id,"Error: No text selected"),c(s.id,"Error: No text selected")}))}(a,d)})),chrome.runtime.onMessage.addListener(((e,t,o)=>{if("openChat"===e.type&&chrome.storage.local.set({aiMessage:e.message},(()=>{chrome.action.setBadgeText({text:"NEW"}),chrome.action.setBadgeBackgroundColor({color:"#00FF00"})})),"popupOpened"===e.type&&chrome.action.setBadgeText({text:""}),"continueChat"===e.type)return fetch("http://localhost:5010/generate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({conversationHistory:e.conversationHistory})}).then((e=>e.json())).then((e=>{e&&e.response?o({answer:e.response}):o({error:"No response from AI"})})).catch((e=>{console.error("Error in continueChat fetch:",e),o({error:"Unable to contact AI server"})})),!0}))})();